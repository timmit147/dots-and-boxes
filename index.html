<html>
<head>
    <title>Chain Reaction</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1>Chain Reaction</h1>
    <div id="auth-container">
        <h2>Sign In / Sign Up</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="signup-button">Sign Up</button>
        <button id="signin-button">Sign In</button>
        <p id="auth-status"></p>
    </div>
    
    <div id="game-lobby-container" style="display:none;">
        <h2>Game Lobby</h2>
        <button id="create-game-button">Create New Game</button>
        <br><br>
        <input type="text" id="game-id-input" placeholder="Enter Game ID">
        <button id="join-game-button">Join Game</button>
        <p id="lobby-status"></p>
        <button id="signout-button">Sign Out</button>
    </div>

    <div id="game-container" style="display:none;">
        <h2>Game Board</h2>
        <p>You are in game: <span id="current-game-id"></span></p>
        <p>Current Turn: <span id="current-player-turn"></span></p>
        <div class="board"></div>
        <button id="leave-game-button">Leave Game</button>
    </div>
    
    <script src="js/script.js"></script>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCQh3iNGIGDVaFTmiEGyZa6r5r7U0thX80",
            authDomain: "box-chain.firebaseapp.com",
            projectId: "box-chain",
            storageBucket: "box-chain.firebasestorage.app",
            messagingSenderId: "957225784449",
            appId: "1:957225784449:web:a02f5e553128cd61e66980"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get DOM elements
        const authContainer = document.getElementById('auth-container');
        const gameLobbyContainer = document.getElementById('game-lobby-container');
        const gameContainer = document.getElementById('game-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signupButton = document.getElementById('signup-button');
        const signinButton = document.getElementById('signin-button');
        const signoutButton = document.getElementById('signout-button');
        const authStatus = document.getElementById('auth-status');
        const createGameButton = document.getElementById('create-game-button');
        const joinGameButton = document.getElementById('join-game-button');
        const gameIdInput = document.getElementById('game-id-input');
        const lobbyStatus = document.getElementById('lobby-status');
        const currentGameIdSpan = document.getElementById('current-game-id');
        const leaveGameButton = document.getElementById('leave-game-button');
        const currentPlayerTurnSpan = document.getElementById('current-player-turn');
        
        let currentUser = null;
        let currentGameId = null;
        let unsubscribeFromGame = null; // To stop listening to Firestore updates

        // --- AUTHENTICATION LOGIC ---
        signupButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    authStatus.textContent = `User ${user.email} signed up successfully!`;
                })
                .catch((error) => {
                    authStatus.textContent = `Sign Up Error: ${error.message}`;
                });
        });

        signinButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    authStatus.textContent = `User ${user.email} signed in successfully!`;
                })
                .catch((error) => {
                    authStatus.textContent = `Sign In Error: ${error.message}`;
                });
        });

        signoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                authStatus.textContent = 'User signed out.';
            }).catch((error) => {
                authStatus.textContent = `Sign Out Error: ${error.message}`;
            });
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                gameLobbyContainer.style.display = 'block';
                console.log('User signed in:', user.email);
            } else {
                currentUser = null;
                authContainer.style.display = 'block';
                gameLobbyContainer.style.display = 'none';
                gameContainer.style.display = 'none';
                console.log('User signed out');
            }
        });

        // --- GAME LOBBY LOGIC ---
        createGameButton.addEventListener('click', async () => {
            if (!currentUser) {
                lobbyStatus.textContent = "Please sign in first.";
                return;
            }

            const gameId = Math.random().toString(36).substring(2, 8);
            const gameRef = doc(db, 'games', gameId);

            await setDoc(gameRef, {
                players: [currentUser.uid],
                status: 'waiting',
                boardState: Array(100).fill(null) // Initialize an empty board
            });

            currentGameId = gameId;
            joinGame(gameId);
        });

        joinGameButton.addEventListener('click', async () => {
            if (!currentUser) {
                lobbyStatus.textContent = "Please sign in first.";
                return;
            }

            const gameId = gameIdInput.value.trim();
            if (!gameId) {
                lobbyStatus.textContent = "Please enter a Game ID.";
                return;
            }

            const gameRef = doc(db, 'games', gameId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists()) {
                const gameData = gameSnap.data();
                if (gameData.players.length < 2) {
                    await updateDoc(gameRef, {
                        players: [...gameData.players, currentUser.uid],
                        status: 'playing',
                        currentPlayer: currentUser.uid // Set the second player as the starting player
                    });
                    currentGameId = gameId;
                    joinGame(gameId);
                } else {
                    lobbyStatus.textContent = "This game is already full.";
                }
            } else {
                lobbyStatus.textContent = "Game not found.";
            }
        });

        function joinGame(gameId) {
            gameLobbyContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            currentGameIdSpan.textContent = gameId;

            const gameRef = doc(db, 'games', gameId);

            // Listen for real-time updates to the game document
            unsubscribeFromGame = onSnapshot(gameRef, (docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    
                    // Update the turn display
                    if (gameData.currentPlayer) {
                        currentPlayerTurnSpan.textContent = (gameData.currentPlayer === currentUser.uid) ? 'Your Turn' : 'Opponent\'s Turn';
                    }
                    
                    // Here you would also update the game board based on gameData.boardState
                    // For now, let's just log it.
                    console.log('Current board state:', gameData.boardState);
                }
            });
        }

        leaveGameButton.addEventListener('click', () => {
            // Stop listening to game updates
            if (unsubscribeFromGame) {
                unsubscribeFromGame();
            }
            currentGameId = null;
            gameLobbyContainer.style.display = 'block';
            gameContainer.style.display = 'none';
        });

        // --- GAME LOGIC ---
        // (This will be integrated from your existing script.js file)
        
    </script>
</body>
</html>